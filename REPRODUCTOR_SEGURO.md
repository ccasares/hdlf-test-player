# üîí Sistema de Reproductor Seguro

## üìñ Descripci√≥n

Este sistema proporciona un reproductor de video ultra-seguro donde **la URL del video NUNCA se expone en el frontend**. El video se transmite a trav√©s de una API proxy con validaci√≥n de tokens de sesi√≥n temporal.

## üéØ Caracter√≠sticas Principales

### üõ°Ô∏è Seguridad M√°xima

- ‚úÖ **URL Oculta**: La URL real del video (`http://quasars.ddns.net:8880/videos/webtest.mp4`) nunca aparece en el c√≥digo frontend
- ‚úÖ **Tokens Temporales**: Cada sesi√≥n tiene un token √∫nico que expira despu√©s de 1 hora
- ‚úÖ **API Proxy**: El video se sirve a trav√©s de `/api/stream.php` que valida el token antes de servir
- ‚úÖ **No Inspecci√≥n**: El inspector del navegador no puede ver la URL real del video
- ‚úÖ **Streaming Seguro**: Soporte completo para Range requests (HTTP 206) sin exponer la fuente

### üé¨ Caracter√≠sticas del Reproductor

- ‚úÖ Controles HTML5 nativos
- ‚úÖ Soporte para seek/scrubbing
- ‚úÖ Temporizador de expiraci√≥n de sesi√≥n
- ‚úÖ Indicadores de estado en tiempo real
- ‚úÖ Prevenci√≥n de clic derecho (opcional)
- ‚úÖ Interfaz moderna y responsive

## üèóÔ∏è Arquitectura del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Usuario       ‚îÇ
‚îÇ   (Navegador)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ 1. Solicita acceso
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  access.php     ‚îÇ ‚óÑ‚îÄ‚îÄ P√°gina de entrada
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ 2. Genera token
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ api/session.php ‚îÇ ‚óÑ‚îÄ‚îÄ Crea token temporal
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ 3. Redirige con token
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  player.html    ‚îÇ ‚óÑ‚îÄ‚îÄ Reproductor seguro
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ 4. Solicita video
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ api/stream.php  ‚îÇ ‚óÑ‚îÄ‚îÄ Proxy que valida y sirve
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ 5. Obtiene video
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Video Remoto   ‚îÇ ‚óÑ‚îÄ‚îÄ http://quasars.ddns.net:8880
‚îÇ  (quasars)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìÅ Estructura de Archivos

```
/
‚îú‚îÄ‚îÄ access.php              # P√°gina de acceso (punto de entrada)
‚îú‚îÄ‚îÄ player.html             # Reproductor seguro
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ session.php         # API de gesti√≥n de tokens
‚îÇ   ‚îî‚îÄ‚îÄ stream.php          # API proxy para streaming
‚îú‚îÄ‚îÄ sessions/               # Tokens temporales (auto-gestionado)
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep
‚îî‚îÄ‚îÄ .env                    # Configuraci√≥n
```

## üöÄ Instalaci√≥n y Configuraci√≥n

### 1. Configurar Variables de Entorno

Edita el archivo `.env`:

```env
# Clave secreta para tokens
SECRET_KEY=tu-clave-secreta-aqui

# Dominio autorizado
ALLOWED_DOMAIN=https://midominio.com

# C√≥digo de acceso opcional (dejar vac√≠o para acceso libre)
ACCESS_CODE=mi-codigo-secreto

# URLs base
BASE_URL=https://tu-app.herokuapp.com
```

### 2. Configurar Permisos

```bash
# Dar permisos de escritura al directorio sessions
chmod 755 sessions/
```

### 3. Configurar Heroku

```bash
# Variables de entorno en Heroku
heroku config:set SECRET_KEY=$(openssl rand -hex 32)
heroku config:set ALLOWED_DOMAIN=https://midominio.com
heroku config:set ACCESS_CODE=opcional-codigo-acceso
heroku config:set BASE_URL=https://tu-app.herokuapp.com
```

## üéÆ Flujo de Uso

### Paso 1: Acceder al Sistema

1. El usuario visita `https://tu-app.herokuapp.com/access.php`
2. Ve una pantalla de bienvenida con opciones:
   - **Acceso Directo**: Si no hay c√≥digo de acceso configurado
   - **Con C√≥digo**: Si `ACCESS_CODE` est√° configurado en `.env`

### Paso 2: Generar Token de Sesi√≥n

1. El usuario hace clic en "Acceder al Reproductor"
2. El sistema llama a `POST /api/session.php?action=create`
3. Se genera un token √∫nico con:
   - Token HMAC-SHA256
   - Timestamp de expiraci√≥n (1 hora por defecto)
   - IP del usuario
   - User-Agent
4. El token se almacena en `sessions/session_{token}.json`

### Paso 3: Acceder al Reproductor

1. El usuario es redirigido a `player.html?token=abc123...`
2. El reproductor valida el token con `GET /api/session.php?action=validate`
3. Si es v√°lido, se habilita la reproducci√≥n

### Paso 4: Reproducir Video

1. El reproductor configura el video source a `/api/stream.php?token=abc123`
2. Cuando el usuario da play:
   - El navegador solicita el video a `/api/stream.php`
   - La API valida el token
   - Si es v√°lido, hace proxy del video desde `quasars.ddns.net:8880`
   - El video se transmite al navegador **sin exponer la URL real**

### Paso 5: Expiraci√≥n

1. El token expira despu√©s de 1 hora
2. El reproductor muestra una advertencia 5 minutos antes
3. Despu√©s de la expiraci√≥n, el usuario debe volver a `access.php`

## üîß API Reference

### POST /api/session.php?action=create

Crea un nuevo token de sesi√≥n.

**Request Body:**
```json
{
  "video_id": "webtest",
  "duration": 3600,
  "access_code": "opcional"
}
```

**Response Success (200):**
```json
{
  "success": true,
  "token": "abc123...",
  "expires": 1729184400,
  "expires_in": 3600,
  "expires_at": "2025-10-17 16:00:00"
}
```

**Response Error (403):**
```json
{
  "success": false,
  "error": "Invalid access code"
}
```

### GET /api/session.php?action=validate&token=...

Valida un token existente.

**Response Success (200):**
```json
{
  "success": true,
  "valid": true,
  "expires": 1729184400,
  "remaining": 2847,
  "video_id": "webtest"
}
```

**Response Error (403):**
```json
{
  "success": false,
  "valid": false,
  "error": "Invalid or expired token"
}
```

### GET /api/stream.php?token=...&video=webtest

Sirve el video a trav√©s del proxy.

**Headers:**
- `Range`: Opcional, para streaming parcial
- `X-Session-Token`: Alternativa al par√°metro token

**Response:**
- **200**: Video completo
- **206**: Contenido parcial (Range request)
- **401**: Token no proporcionado
- **403**: Token inv√°lido o expirado
- **404**: Video no encontrado
- **502**: Video remoto no disponible

## üîê Seguridad

### ¬øC√≥mo se Protege la URL?

1. **Frontend NO conoce la URL**: 
   - `player.html` solo conoce `/api/stream.php`
   - La URL real est√° hardcodeada en `api/stream.php` (backend)

2. **Validaci√≥n en cada request**:
   - Cada chunk del video requiere token v√°lido
   - El token se valida en el servidor antes de hacer proxy

3. **Tokens de un solo uso por sesi√≥n**:
   - Un token solo funciona para una IP/User-Agent
   - Expira autom√°ticamente despu√©s de 1 hora

4. **Sin cach√© de URL**:
   - El video se transmite en streaming, no se descarga
   - El browser no puede ver la URL de origen

### ¬øSe Puede Hackear?

**Inspecci√≥n del navegador:**
- ‚ùå No ver√° la URL real, solo `/api/stream.php?token=...`
- ‚úÖ Puede copiar el token, pero:
  - Solo funciona por 1 hora
  - Solo desde la misma IP (opcional)
  - Solo con el mismo User-Agent (opcional)

**Copiar el token:**
- Si alguien copia el token y lo usa en otro navegador:
  - Funcionar√° solo si est√° en la misma IP (por defecto)
  - Puedes agregar validaci√≥n adicional de User-Agent
  - El token expira en 1 hora

**Descargar el video:**
- T√©cnicamente posible con herramientas como `wget` + token
- Pero requiere:
  - Tener acceso al sistema
  - Generar un token v√°lido
  - Descargar dentro de 1 hora
- Es similar a cualquier sistema de streaming (Netflix, YouTube, etc.)

### Mejoras de Seguridad Adicionales

Puedes agregar en `api/stream.php`:

```php
// Validar IP
if ($session['ip'] !== $_SERVER['REMOTE_ADDR']) {
    sendError(403, 'IP mismatch');
}

// Validar User-Agent
if ($session['user_agent'] !== $_SERVER['HTTP_USER_AGENT']) {
    sendError(403, 'User-Agent mismatch');
}

// Limitar n√∫mero de reproducciones
if ($session['play_count'] >= 3) {
    sendError(403, 'Max plays exceeded');
}
```

## üé® Personalizaci√≥n

### Cambiar Duraci√≥n de la Sesi√≥n

En `api/session.php`, cambia:

```php
$SESSION_DURATION = 3600; // 1 hora
// A:
$SESSION_DURATION = 7200; // 2 horas
```

### Agregar M√°s Videos

En `api/stream.php`, modifica el array `$videoUrls`:

```php
$videoUrls = [
    'webtest' => 'http://quasars.ddns.net:8880/videos/webtest.mp4',
    'video2' => 'http://quasars.ddns.net:8880/videos/otro-video.mp4',
    'video3' => 'https://otro-servidor.com/video.mp4'
];
```

Luego accede con: `/api/stream.php?token=...&video=video2`

### Habilitar C√≥digo de Acceso

En `.env`:

```env
ACCESS_CODE=mi-codigo-secreto-123
```

En Heroku:

```bash
heroku config:set ACCESS_CODE=mi-codigo-secreto-123
```

### Personalizar la UI

Los archivos HTML (`access.php` y `player.html`) tienen CSS inline que puedes modificar f√°cilmente.

## üìä Monitoreo

### Ver Sesiones Activas

```bash
# Linux/Mac
ls -lh sessions/

# Ver contenido de una sesi√≥n
cat sessions/session_abc123.json
```

### Limpiar Sesiones Expiradas

Las sesiones se limpian autom√°ticamente, pero puedes forzar:

```bash
find sessions/ -name "session_*.json" -mmin +60 -delete
```

## üêõ Soluci√≥n de Problemas

### Error: "Session token required"

**Causa**: No se proporcion√≥ token o se perdi√≥ en la URL

**Soluci√≥n**: Vuelve a `access.php` y genera un nuevo token

### Error: "Invalid or expired session token"

**Causa**: El token expir√≥ (>1 hora) o es inv√°lido

**Soluci√≥n**: Genera un nuevo token desde `access.php`

### Error: "Remote video not available"

**Causa**: El servidor `quasars.ddns.net:8880` no est√° disponible

**Soluci√≥n**: Verifica que el servidor de videos est√© en l√≠nea

### El video no carga

1. Abre la consola del navegador (F12)
2. Verifica errores en la pesta√±a Console
3. Verifica que el token sea v√°lido: `/api/session.php?action=validate&token=TU_TOKEN`
4. Verifica que la API de streaming responda: `/api/stream.php?token=TU_TOKEN`

### Sesiones no se limpian

**Causa**: PHP no tiene permisos de escritura en `/sessions/`

**Soluci√≥n**:
```bash
chmod 755 sessions/
```

## üåê Despliegue en Heroku

Ya est√° configurado para Heroku con `composer.json` y `Procfile`.

```bash
# Deploy
git add .
git commit -m "Add secure video player"
git push heroku main

# Configurar variables
heroku config:set SECRET_KEY=$(openssl rand -hex 32)
heroku config:set BASE_URL=$(heroku info -s | grep web_url | cut -d= -f2)
```

## üìù Ejemplo de Uso Completo

1. **Usuario visita**: `https://mi-app.herokuapp.com/access.php`
2. **Usuario hace clic**: "Acceso Directo"
3. **Sistema genera token**: `abc123def456...`
4. **Usuario es redirigido**: `https://mi-app.herokuapp.com/player.html?token=abc123...`
5. **Reproductor valida token**: ‚úì V√°lido
6. **Usuario da play**: Video comienza
7. **Browser solicita**: `GET /api/stream.php?token=abc123...`
8. **API valida**: Token v√°lido ‚Üí hace proxy del video
9. **Video se reproduce**: Sin exponer URL real
10. **Despu√©s de 1 hora**: Token expira, usuario debe renovar

## üéâ Ventajas del Sistema

- ‚úÖ **M√°xima Seguridad**: URL nunca expuesta al cliente
- ‚úÖ **F√°cil de Usar**: Solo visitar una p√°gina
- ‚úÖ **Escalable**: Agregar m√°s videos es simple
- ‚úÖ **Compatible**: Funciona en todos los navegadores modernos
- ‚úÖ **Flexible**: C√≥digo de acceso opcional
- ‚úÖ **Auditable**: Cada sesi√≥n se registra con IP y User-Agent

---

**¬°Tu video est√° ahora ultra-protegido! üîíüé¨**

Para m√°s informaci√≥n, consulta el `README.md` principal.

